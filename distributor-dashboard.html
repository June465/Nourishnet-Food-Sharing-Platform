<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Distributor Dashboard - NourishNet</title>
    <!-- Swiper CSS (Optional) -->
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/practice.css" /> <!-- Keep existing link -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/dashboard.css" /> <!-- Link dashboard CSS -->
    <link rel="icon" type="image/png" sizes="32x32" href="images/logo.jpg" />
  </head>
  <body>
    <!-- Header (Dashboard Navigation) -->
    <section class="header">
      <a href="index.html" class="logo">NOURISH<span class="highlight">NET</span></a>
      <nav class="navbar">
        <!-- This navbar is replaced by auth.js if user is logged in -->
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="donations.html">Donations</a>
        <a href="distributor-dashboard.html">Dashboard</a>
        <a href="login.html">Login</a>
      </nav>
      <div id="menu-btn" class="fas fa-bars"></div>
    </section>

    <!-- Heading -->
    <div class="heading" style="background: url(images/header-food.jpg) no-repeat center/cover">
      <h1>Distributor Dashboard</h1>
    </div>

    <!-- Dashboard Section -->
    <section class="dashboard">
      <h2 class="dashboard-title">Manage Your Donations</h2>

      <div class="dashboard-grid"> <!-- Optional: Use grid for layout -->

        <!-- Log Food Donation Form Section -->
        <div class="dashboard-section form-section">
          <h3><i class="fas fa-plus-circle"></i> Add New Food Donation</h3>
          <!-- Use fetch API, so remove action/method. Add enctype for file upload. -->
          <form id="donation-form" enctype="multipart/form-data">
             <div class="inputBox">
                <span>Food Type / Description <span style="color:red">*</span></span>
                <input type="text" name="foodType" placeholder="e.g., Vegetable Curry, Assorted Pastries" required />
              </div>
            <div class="inputBox">
              <span>Allergy Information <span style="color:red">*</span></span>
              <input type="text" name="allergy" placeholder="e.g., Contains Nuts, Gluten-Free, None" required />
            </div>
            <div class="inputBox">
              <span>Quantity (Servings/Items) <span style="color:red">*</span></span>
              <input type="number" name="quantity" placeholder="e.g., 50" min="1" required />
            </div>
            <div class="inputBox">
              <span>Pickup Location <span style="color:red">*</span></span>
              <input type="text" name="location" placeholder="Enter full address or specific location" required />
            </div>
            <div class="inputBox">
              <span>Available Pickup Timing <span style="color:red">*</span></span>
              <input type="text" name="pickupTime" placeholder="e.g., Today 4 PM - 6 PM, Mon-Fri 9 AM - 12 PM" required />
            </div>
            <div class="inputBox">
              <span>Use-By Date & Time <span style="color:red">*</span></span>
              <input type="datetime-local" name="useBy" required />
            </div>
            <div class="inputBox">
              <span>Upload Food Image <span style="color:red">*</span></span>
              <input type="file" name="foodImage" accept="image/png, image/jpeg, image/webp" required />
            </div>

            <!-- Hidden field for distributor ID added by JS -->
            <div id="donation-message" style="margin-top: 10px; font-weight: bold;"></div>
            <input type="submit" value="Log Donation" class="btn" />
          </form>
        </div>

        <!-- Active Donations & Prior Deliveries Section -->
        <div class="dashboard-section info-section">
          <h3><i class="fas fa-list-alt"></i> Donation & Delivery Overview</h3>

          <div class="active-donations">
            <h4><i class="fas fa-hourglass-half"></i> Your Active Donations</h4>
            <div id="active-donations-list">
              <p>Loading active donations...</p>
            </div>
          </div>

          <div class="prior-deliveries">
            <h4><i class="fas fa-check-circle"></i> Completed Deliveries & Feedback</h4>
            <div id="delivery-history">
              <p>Loading delivery history...</p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Optional: Modal/Overlay for Editing Donation -->
    <div id="edit-donation-modal" class="overlay" style="display: none;">
        <!-- Content for editing form would go here -->
    </div>

     <!-- Optional: Modal/Overlay for Viewing Feedback Detail -->
    <div id="feedback-detail-modal" class="overlay" style="display: none;">
         <!-- Content for showing detailed feedback would go here -->
    </div>


    <!-- Social Section -->
    <section class="social-section">
      <h2>Be part of our mission</h2>
      <p>
        Be part of our mission to reduce food waste and nourish communities in need. Connect with us on these platforms.
      </p>
      <div class="social-icons">
        <div class="social-item">
          <i class="fab fa-facebook-f facebook-link"></i>
          <a href="#" class="facebook-link">Facebook</a>
        </div>
        <div class="social-item">
          <i class="fab fa-twitter twitter-link"></i>
          <a href="#" class="twitter-link">Twitter</a>
        </div>
        <div class="social-item">
          <i class="fab fa-instagram instagram-link"></i>
          <a href="#" class="instagram-link">Instagram</a>
        </div>
        <div class="social-item">
          <i class="fab fa-linkedin-in linkedin-link"></i>
          <a href="#" class="linkedin-link">LinkedIn</a>
        </div>
      </div>
    </section>

    <!-- Footer Section -->
    <footer class="footer">
      <div class="footer-container">
        <div class="footer-left">
          <h2 class="brand">NOURISH<span class="highlight">NET</span></h2>
          <p>Connecting surplus food to those in need.</p>
        </div>
        <div class="footer-links">
          <h3>Quick Links</h3>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="#">Initiatives</a></li>
            <li><a href="#">Partners</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
        </div>
        <div class="footer-links">
          <h3>Legal</h3>
          <ul>
            <li><a href="#">Privacy Policy</a></li>
            <li><a href="#">Terms of Use</a></li>
            <li><a href="#">Refund & Cancellation Policy</a></li>
          </ul>
        </div>
        <div class="footer-contact">
          <h3>GET IN TOUCH</h3>
          <p>ðŸ“§ <a href="mailto:support@nourishnet.org">Support@NourishNet.org</a></p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>Copyright Â© 2025 NourishNet. All Rights Reserved.</p>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script> 
    <script src="js/script.js"></script> <!-- For menu -->
    <script src="js/auth.js"></script> <!-- For nav -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(localStorage.getItem('user'));
        // Redirect if not logged in or not a distributor
        if (!user || user.role !== 'distributor') {
          alert('Access denied. Please login as a distributor.');
          window.location.href = 'login.html';
          return;
        }

        const donationForm = document.getElementById('donation-form');
        const messageDiv = document.getElementById('donation-message');

        // Add hidden input for distributor ID to the form
        let distributorHidden = donationForm.querySelector('input[name="distributor"]');
        if (!distributorHidden) {
             distributorHidden = document.createElement('input');
             distributorHidden.type = 'hidden';
             distributorHidden.name = 'distributor';
             donationForm.appendChild(distributorHidden);
        }
        distributorHidden.value = user._id || user.id; // Use _id if available from MongoDB

        // Handle form submission via fetch
        donationForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          messageDiv.textContent = 'Submitting...';
          messageDiv.style.color = 'orange';

          const formData = new FormData(donationForm);
          // Optional: Validate date/time before sending
          const useByDate = new Date(formData.get('useBy'));
          if (isNaN(useByDate) || useByDate <= new Date()) {
             messageDiv.textContent = 'Error: Please enter a valid future Use-By Date & Time.';
             messageDiv.style.color = 'red';
             return;
          }


          try {
            const response = await fetch('/api/donations/add', {
              method: 'POST',
              body: formData // FormData handles multipart/form-data encoding
              // No 'Content-Type' header needed when using FormData with fetch
            });

            // Check if response is ok (status 200-299)
             if (!response.ok) {
                 // Try to parse error message from backend if available
                 let errorMsg = `HTTP error! status: ${response.status}`;
                 try {
                     const errorData = await response.json();
                     errorMsg = errorData.message || errorMsg;
                 } catch (jsonError) {
                     // Ignore if response wasn't JSON
                 }
                 throw new Error(errorMsg);
             }

            const data = await response.json();

            if (data.success) {
              messageDiv.textContent = 'Donation added successfully!';
              messageDiv.style.color = 'green';
              donationForm.reset(); // Clear the form
              // Reload the active donations list
              loadDistributorData(user._id || user.id);
               // Clear message after a few seconds
              setTimeout(() => { messageDiv.textContent = ''; }, 5000);
            } else {
              messageDiv.textContent = 'Error: ' + (data.message || 'Could not add donation.');
              messageDiv.style.color = 'red';
            }
          } catch (err) {
            console.error('Donation submission error:', err);
            messageDiv.textContent = `An error occurred: ${err.message}. Please try again.`;
            messageDiv.style.color = 'red';
          }
        });

        // Load existing dashboard data on page load
        loadDistributorData(user._id || user.id);
      });

      // Function to load distributor's active donations and delivery history
      async function loadDistributorData(distributorId) {
        const activeListContainer = document.getElementById('active-donations-list');
        const historyContainer = document.getElementById('delivery-history');
        activeListContainer.innerHTML = '<p>Loading active donations...</p>';
        historyContainer.innerHTML = '<p>Loading delivery history...</p>';

        try {
          const res = await fetch(`/api/dashboard/distributor/${distributorId}`);
          const data = await res.json();

          if (data.success) {

            // ***** STEP 1: Declare feedbackStatuses HERE *****
            let feedbackStatuses = {}; // Use let, initialize as empty object

            // ***** STEP 2: Call check function only if needed *****
            // Check if orderHistory exists before trying to map it or call the function
            if (data.orderHistory && data.orderHistory.length > 0) {
                 console.log("Order history found, checking feedback statuses...");
                 // Assign the result to the already declared variable
                 feedbackStatuses = await checkFeedbackStatusForDistributor(data.orderHistory.map(o => o._id));
            } else {
                 console.log("No order history, skipping feedback status check.");
                 // feedbackStatuses remains {}
            }
            // ^^^^ Now feedbackStatuses is defined and in scope for the rest of the function ^^^^


            // --- Populate Active Donations ---
            // (No changes needed inside this block related to feedbackStatuses)
            if (data.activeDonations && data.activeDonations.length > 0) {
              activeListContainer.innerHTML = '';
              data.activeDonations.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
              data.activeDonations.forEach(donation => {
                const item = document.createElement('div');
                item.classList.add('active-donation-item');
                item.innerHTML = `
                  <div>
                    <p><strong>ID:</strong> ${donation._id}</p>
                    <p><strong>Type:</strong> ${donation.foodType}</p>
                    <p><strong>Quantity Left:</strong> ${donation.quantity} servings</p>
                    <p><strong>Use By:</strong> ${new Date(donation.useBy).toLocaleString()}</p>
                  </div>
                  <div>
                    <button class="btn edit-btn" onclick="openEditDonationModal('${donation._id}')">Edit</button>
                    <!-- <button class="btn delete-btn" onclick="deleteDonation('${donation._id}')">Delete</button> -->
                  </div>
                `;
                activeListContainer.appendChild(item);
              });
            } else {
              activeListContainer.innerHTML = '<p>You have no active donations.</p>';
            }


            // --- Populate Prior Deliveries & Feedback ---
            if (data.orderHistory && data.orderHistory.length > 0) {
              historyContainer.innerHTML = '';
              data.orderHistory.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

              const feedbackMap = {}; // This is separate and fine

              // ***** STEP 3: Use the feedbackStatuses declared above *****
              // The if(feedbackStatuses) check is still okay, it will check if the object is truthy (it always will be now)
              if (feedbackStatuses) {
                    Object.entries(feedbackStatuses).forEach(([orderId, feedback]) => {
                        if (feedback) {
                             feedbackMap[orderId] = feedback;
                        }
                    });
              }
              console.log("Using feedback map to render history:", feedbackMap);

              // ... rest of the code to loop through orderHistory and use feedbackMap ...
              data.orderHistory.forEach(order => {
                const item = document.createElement('div');
                item.classList.add('delivery-item');
                const feedback = feedbackMap[order._id]; // Get feedback using the map

                item.innerHTML = `
                    <div>
                         <p><strong>Order ID:</strong> ${order._id}</p>
                         <p><strong>Donation ID:</strong> ${order.donationId}</p>
                         <p><strong>Collector ID:</strong> ${order.collector}</p>
                         <p><strong>Items Taken:</strong> ${order.itemCount}</p>
                         <p><strong>Date:</strong> ${new Date(order.orderDate).toLocaleDateString()}</p>
                    </div>
                     <div class="feedback-section">
                         ${feedback ? `
                             <p><strong>Feedback Received:</strong></p>
                             <div class="feedback-details">
                                <span class="rating">${generateStars(feedback.rating)}</span>
                                ${feedback.comment || 'No comment provided.'} <!-- Added fallback -->
                                <span style="display:block; font-size: 0.8em; color: #888;"> on ${new Date(feedback.createdAt).toLocaleDateString()}</span>
                             </div>
                         ` : `
                             <p><i>No feedback submitted yet.</i></p>
                         `}
                     </div>
                `;
                historyContainer.appendChild(item);
              });
              // ... end of loop ...
            } else {
              // This case is handled above now
              historyContainer.innerHTML = '<p>No deliveries have been completed yet.</p>';
            }
          } else {
             // Handle API failure (data.success is false)
             console.error("API call failed:", data.message);
             activeListContainer.innerHTML = `<p>Could not load donations: ${data.message || 'Unknown error'}</p>`;
             historyContainer.innerHTML = `<p>Could not load delivery history: ${data.message || 'Unknown error'}</p>`;
          }
        } catch (err) {
           // Handle errors during fetch/JSON parsing or processing
           console.error('Error in loadDistributorData:', err);
           activeListContainer.innerHTML = '<p>Error loading data. Please refresh.</p>';
           historyContainer.innerHTML = '<p>Error loading data. Please refresh.</p>';
        }
      }

      // Helper to generate star icons
      function generateStars(rating) {
          let stars = '';
          for (let i = 1; i <= 5; i++) {
              stars += `<i class="fas fa-star" style="color: ${i <= rating ? 'gold' : '#ccc'};"></i>`;
          }
          return stars;
      }


      // Helper function to fetch feedback for the distributor's orders
      async function checkFeedbackStatusForDistributor(orderIds) {
            // 1. Handle case where no order IDs are provided
            if (!orderIds || orderIds.length === 0) {
                console.log("checkFeedbackStatusForDistributor: No order IDs to check.");
                return {}; // Return empty object immediately
            }

            // 2. Wrap the main logic in try...catch
            try {
                console.log("checkFeedbackStatusForDistributor: Checking feedback for orders:", orderIds);
                const res = await fetch('/api/feedback/all'); // Fetch all feedback

                // 3. Check if the fetch itself was successful (status 200-299)
                if (!res.ok) {
                    // Log the HTTP error status and return an empty object
                    console.error(`checkFeedbackStatusForDistributor: Failed to fetch feedback - HTTP status ${res.status}`);
                    return {}; // Return empty object so the calling function doesn't break
                }

                // 4. Try to parse the JSON response
                const data = await res.json();

                // 5. Check if the API indicated success and returned feedbacks
                if (!data.success || !data.feedbacks) {
                    console.warn("checkFeedbackStatusForDistributor: API did not return success or feedbacks array.", data);
                    return {}; // Return empty object if API response isn't as expected
                }

                // 6. Process the feedbacks if everything is okay
                console.log(`checkFeedbackStatusForDistributor: Received ${data.feedbacks.length} total feedbacks.`);
                const feedbackMap = {};
                data.feedbacks.forEach(fb => {
                    // Check if the feedback belongs to one of the requested orderIds
                    if (orderIds.includes(fb.orderId)) {
                        feedbackMap[fb.orderId] = fb; // Store the feedback object
                    }
                });

                console.log("checkFeedbackStatusForDistributor: Constructed feedback map:", feedbackMap);
                return feedbackMap; // Return the resulting map

            } catch (err) {
                // 7. Catch any errors during fetch or JSON parsing
                console.error("checkFeedbackStatusForDistributor: Error occurred:", err);
                // IMPORTANT: Return an empty object here too!
                return {}; // Ensures feedbackStatuses will always be defined, even if empty
            }
        }


      // Placeholder function for editing donations
      function openEditDonationModal(donationId) {
        alert(`Edit functionality for donation ${donationId} is not fully implemented yet.`);
        // TODO: Fetch donation data, populate a modal form, handle PUT request on submit
        // const modal = document.getElementById('edit-donation-modal');
        // modal.style.display = 'flex';
        // Load edit form content...
      }

       // Placeholder function for viewing feedback detail
       function showFeedbackDetail(feedbackId) {
            alert(`Viewing detail for feedback ${feedbackId} not implemented yet.`);
            // const modal = document.getElementById('feedback-detail-modal');
            // Fetch feedback detail, populate modal...
            // modal.style.display = 'flex';
       }

    </script>
  </body>
</html>